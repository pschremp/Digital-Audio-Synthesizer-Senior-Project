/*
 * Osc.c
 *
 *	Creates 4 independent oscillators
 *  Created on: May 10, 2024
 *      Author: pschr
 */

#include "Osc.h"
#include "stdint.h"
#include "stdlib.h"
#include "lin_to_exp_lut.h"
#include "math.h"
#include "stm32746g_discovery.h"

#define SAMPLE_BUFFER_SIZE 2048

int sample_value_osc1[] = {0};
int sample_value_osc2[] = {0};
int sample_value_osc3[] = {0};
int sample_value_osc4[] = {0};
int osc1_sample_index[] = {0};
int osc2_sample_index[] = {0};
int osc3_sample_index[] = {0};
int osc4_sample_index[] = {0};
enum wave_shape{SQU, SAW, TRI, SIN, NOI};
const int16_t osc_sin_lut[] = {0,21,43,64,86,107,129,150,172,193,214,236,257,279,300,322,343,364,386,407,429,450,472,493,514,536,557,579,600,621,643,664,685,707,728,749,771,792,814,835,856,878,899,920,941,963,984,1005,1027,1048,1069,1090,1112,1133,1154,1175,1197,1218,1239,1260,1281,1303,1324,1345,1366,1387,1408,1429,1450,1472,1493,1514,1535,1556,1577,1598,1619,1640,1661,1682,1703,1724,1745,1766,1787,1808,1829,1850,1870,1891,1912,1933,1954,1975,1995,2016,2037,2058,2079,2099,2120,2141,2161,2182,2203,2223,2244,2265,2285,2306,2326,2347,2367,2388,2408,2429,2449,2470,2490,2511,2531,2552,2572,2592,2613,2633,2653,2673,2694,2714,2734,2754,2775,2795,2815,2835,2855,2875,2895,2915,2935,2955,2975,2995,3015,3035,3055,3075,3095,3115,3135,3154,3174,3194,3214,3233,3253,3273,3292,3312,3332,3351,3371,3390,3410,3429,3449,3468,3488,3507,3526,3546,3565,3584,3604,3623,3642,3661,3680,3700,3719,3738,3757,3776,3795,3814,3833,3852,3871,3890,3908,3927,3946,3965,3984,4002,4021,4040,4058,4077,4095,4114,4133,4151,4170,4188,4206,4225,4243,4261,4280,4298,4316,4335,4353,4371,4389,4407,4425,4443,4461,4479,4497,4515,4533,4551,4568,4586,4604,4622,4639,4657,4675,4692,4710,4727,4745,4762,4780,4797,4815,4832,4849,4866,4884,4901,4918,4935,4952,4969,4986,5003,5020,5037,5054,5071,5088,5105,5121,5138,5155,5171,5188,5205,5221,5238,5254,5271,5287,5303,5320,5336,5352,5368,5385,5401,5417,5433,5449,5465,5481,5497,5513,5528,5544,5560,5576,5591,5607,5623,5638,5654,5669,5685,5700,5716,5731,5746,5762,5777,5792,5807,5822,5837,5852,5867,5882,5897,5912,5927,5942,5956,5971,5986,6000,6015,6029,6044,6058,6073,6087,6101,6116,6130,6144,6158,6172,6187,6201,6215,6228,6242,6256,6270,6284,6298,6311,6325,6339,6352,6366,6379,6393,6406,6419,6433,6446,6459,6472,6485,6498,6511,6524,6537,6550,6563,6576,6589,6601,6614,6627,6639,6652,6664,6677,6689,6701,6714,6726,6738,6750,6763,6775,6787,6799,6811,6822,6834,6846,6858,6870,6881,6893,6904,6916,6927,6939,6950,6961,6973,6984,6995,7006,7017,7028,7039,7050,7061,7072,7083,7094,7104,7115,7126,7136,7147,7157,7167,7178,7188,7198,7209,7219,7229,7239,7249,7259,7269,7279,7288,7298,7308,7318,7327,7337,7346,7356,7365,7375,7384,7393,7402,7411,7421,7430,7439,7448,7456,7465,7474,7483,7492,7500,7509,7517,7526,7534,7543,7551,7559,7567,7576,7584,7592,7600,7608,7616,7624,7631,7639,7647,7655,7662,7670,7677,7685,7692,7699,7707,7714,7721,7728,7735,7742,7749,7756,7763,7770,7777,7783,7790,7797,7803,7810,7816,7823,7829,7835,7841,7848,7854,7860,7866,7872,7878,7883,7889,7895,7901,7906,7912,7917,7923,7928,7934,7939,7944,7949,7955,7960,7965,7970,7975,7979,7984,7989,7994,7998,8003,8008,8012,8016,8021,8025,8029,8034,8038,8042,8046,8050,8054,8058,8062,8065,8069,8073,8076,8080,8083,8087,8090,8093,8097,8100,8103,8106,8109,8112,8115,8118,8121,8124,8126,8129,8132,8134,8137,8139,8142,8144,8146,8148,8150,8153,8155,8157,8159,8160,8162,8164,8166,8167,8169,8171,8172,8173,8175,8176,8177,8179,8180,8181,8182,8183,8184,8185,8185,8186,8187,8188,8188,8189,8189,8190,8190,8190,8191,8191,8191,8191,8191,8191,8191,8191,8191,8190,8190,8190,8189,8189,8188,8188,8187,8186,8185,8185,8184,8183,8182,8181,8180,8179,8177,8176,8175,8173,8172,8171,8169,8167,8166,8164,8162,8160,8159,8157,8155,8153,8151,8148,8146,8144,8142,8139,8137,8134,8132,8129,8126,8124,8121,8118,8115,8112,8109,8106,8103,8100,8097,8093,8090,8087,8083,8080,8076,8073,8069,8065,8062,8058,8054,8050,8046,8042,8038,8034,8029,8025,8021,8016,8012,8008,8003,7998,7994,7989,7984,7979,7975,7970,7965,7960,7955,7949,7944,7939,7934,7928,7923,7917,7912,7906,7901,7895,7889,7883,7878,7872,7866,7860,7854,7848,7841,7835,7829,7823,7816,7810,7803,7797,7790,7783,7777,7770,7763,7756,7749,7742,7735,7728,7721,7714,7707,7699,7692,7685,7677,7670,7662,7655,7647,7639,7631,7624,7616,7608,7600,7592,7584,7576,7568,7559,7551,7543,7534,7526,7517,7509,7500,7492,7483,7474,7465,7456,7448,7439,7430,7421,7411,7402,7393,7384,7375,7365,7356,7346,7337,7327,7318,7308,7298,7288,7279,7269,7259,7249,7239,7229,7219,7209,7198,7188,7178,7167,7157,7147,7136,7126,7115,7104,7094,7083,7072,7061,7050,7039,7028,7017,7006,6995,6984,6973,6961,6950,6939,6927,6916,6904,6893,6881,6870,6858,6846,6834,6822,6811,6799,6787,6775,6763,6750,6738,6726,6714,6701,6689,6677,6664,6652,6639,6627,6614,6601,6589,6576,6563,6550,6537,6524,6511,6498,6485,6472,6459,6446,6433,6419,6406,6393,6379,6366,6352,6339,6325,6311,6298,6284,6270,6256,6242,6228,6215,6201,6187,6172,6158,6144,6130,6116,6101,6087,6073,6058,6044,6029,6015,6000,5986,5971,5956,5942,5927,5912,5897,5882,5867,5852,5837,5822,5807,5792,5777,5762,5746,5731,5716,5700,5685,5669,5654,5638,5623,5607,5591,5576,5560,5544,5528,5513,5497,5481,5465,5449,5433,5417,5401,5385,5368,5352,5336,5320,5303,5287,5271,5254,5238,5221,5205,5188,5171,5155,5138,5121,5105,5088,5071,5054,5037,5020,5003,4986,4969,4952,4935,4918,4901,4884,4866,4849,4832,4815,4797,4780,4762,4745,4727,4710,4692,4675,4657,4639,4622,4604,4586,4569,4551,4533,4515,4497,4479,4461,4443,4425,4407,4389,4371,4353,4335,4316,4298,4280,4262,4243,4225,4206,4188,4170,4151,4133,4114,4096,4077,4058,4040,4021,4002,3984,3965,3946,3927,3908,3890,3871,3852,3833,3814,3795,3776,3757,3738,3719,3700,3680,3661,3642,3623,3604,3584,3565,3546,3526,3507,3488,3468,3449,3429,3410,3390,3371,3351,3332,3312,3292,3273,3253,3233,3214,3194,3174,3154,3135,3115,3095,3075,3055,3035,3015,2995,2975,2955,2935,2915,2895,2875,2855,2835,2815,2795,2775,2754,2734,2714,2694,2674,2653,2633,2613,2592,2572,2552,2531,2511,2490,2470,2449,2429,2409,2388,2367,2347,2326,2306,2285,2265,2244,2223,2203,2182,2161,2141,2120,2099,2079,2058,2037,2016,1995,1975,1954,1933,1912,1891,1870,1850,1829,1808,1787,1766,1745,1724,1703,1682,1661,1640,1619,1598,1577,1556,1535,1514,1493,1472,1451,1429,1408,1387,1366,1345,1324,1303,1281,1260,1239,1218,1197,1175,1154,1133,1112,1090,1069,1048,1027,1005,984,963,941,920,899,878,856,835,814,792,771,750,728,707,685,664,643,621,600,579,557,536,514,493,472,450,429,407,386,364,343,322,300,279,257,236,214,193,172,150,129,107,86,64,43,21,0,-21,-43,-64,-86,-107,-129,-150,-172,-193,-214,-236,-257,-279,-300,-322,-343,-364,-386,-407,-429,-450,-471,-493,-514,-536,-557,-578,-600,-621,-643,-664,-685,-707,-728,-749,-771,-792,-814,-835,-856,-877,-899,-920,-941,-963,-984,-1005,-1027,-1048,-1069,-1090,-1112,-1133,-1154,-1175,-1197,-1218,-1239,-1260,-1281,-1303,-1324,-1345,-1366,-1387,-1408,-1429,-1450,-1472,-1493,-1514,-1535,-1556,-1577,-1598,-1619,-1640,-1661,-1682,-1703,-1724,-1745,-1766,-1787,-1808,-1829,-1850,-1870,-1891,-1912,-1933,-1954,-1975,-1995,-2016,-2037,-2058,-2079,-2099,-2120,-2141,-2161,-2182,-2203,-2223,-2244,-2265,-2285,-2306,-2326,-2347,-2367,-2388,-2408,-2429,-2449,-2470,-2490,-2511,-2531,-2552,-2572,-2592,-2613,-2633,-2653,-2673,-2694,-2714,-2734,-2754,-2775,-2795,-2815,-2835,-2855,-2875,-2895,-2915,-2935,-2955,-2975,-2995,-3015,-3035,-3055,-3075,-3095,-3115,-3135,-3154,-3174,-3194,-3214,-3233,-3253,-3273,-3292,-3312,-3332,-3351,-3371,-3390,-3410,-3429,-3449,-3468,-3488,-3507,-3526,-3546,-3565,-3584,-3604,-3623,-3642,-3661,-3680,-3699,-3719,-3738,-3757,-3776,-3795,-3814,-3833,-3852,-3871,-3890,-3908,-3927,-3946,-3965,-3984,-4002,-4021,-4040,-4058,-4077,-4095,-4114,-4133,-4151,-4170,-4188,-4206,-4225,-4243,-4261,-4280,-4298,-4316,-4334,-4353,-4371,-4389,-4407,-4425,-4443,-4461,-4479,-4497,-4515,-4533,-4551,-4568,-4586,-4604,-4622,-4639,-4657,-4675,-4692,-4710,-4727,-4745,-4762,-4780,-4797,-4815,-4832,-4849,-4866,-4884,-4901,-4918,-4935,-4952,-4969,-4986,-5003,-5020,-5037,-5054,-5071,-5088,-5105,-5121,-5138,-5155,-5171,-5188,-5205,-5221,-5238,-5254,-5271,-5287,-5303,-5320,-5336,-5352,-5368,-5385,-5401,-5417,-5433,-5449,-5465,-5481,-5497,-5513,-5528,-5544,-5560,-5576,-5591,-5607,-5623,-5638,-5654,-5669,-5685,-5700,-5716,-5731,-5746,-5761,-5777,-5792,-5807,-5822,-5837,-5852,-5867,-5882,-5897,-5912,-5927,-5942,-5956,-5971,-5986,-6000,-6015,-6029,-6044,-6058,-6073,-6087,-6101,-6116,-6130,-6144,-6158,-6172,-6186,-6201,-6215,-6228,-6242,-6256,-6270,-6284,-6298,-6311,-6325,-6339,-6352,-6366,-6379,-6392,-6406,-6419,-6433,-6446,-6459,-6472,-6485,-6498,-6511,-6524,-6537,-6550,-6563,-6576,-6589,-6601,-6614,-6627,-6639,-6652,-6664,-6677,-6689,-6701,-6714,-6726,-6738,-6750,-6763,-6775,-6787,-6799,-6811,-6822,-6834,-6846,-6858,-6870,-6881,-6893,-6904,-6916,-6927,-6939,-6950,-6961,-6973,-6984,-6995,-7006,-7017,-7028,-7039,-7050,-7061,-7072,-7083,-7094,-7104,-7115,-7126,-7136,-7147,-7157,-7167,-7178,-7188,-7198,-7209,-7219,-7229,-7239,-7249,-7259,-7269,-7279,-7288,-7298,-7308,-7318,-7327,-7337,-7346,-7356,-7365,-7374,-7384,-7393,-7402,-7411,-7421,-7430,-7439,-7448,-7456,-7465,-7474,-7483,-7492,-7500,-7509,-7517,-7526,-7534,-7543,-7551,-7559,-7567,-7576,-7584,-7592,-7600,-7608,-7616,-7624,-7631,-7639,-7647,-7655,-7662,-7670,-7677,-7685,-7692,-7699,-7707,-7714,-7721,-7728,-7735,-7742,-7749,-7756,-7763,-7770,-7777,-7783,-7790,-7797,-7803,-7810,-7816,-7823,-7829,-7835,-7841,-7848,-7854,-7860,-7866,-7872,-7878,-7883,-7889,-7895,-7901,-7906,-7912,-7917,-7923,-7928,-7934,-7939,-7944,-7949,-7955,-7960,-7965,-7970,-7975,-7979,-7984,-7989,-7994,-7998,-8003,-8008,-8012,-8016,-8021,-8025,-8029,-8034,-8038,-8042,-8046,-8050,-8054,-8058,-8062,-8065,-8069,-8073,-8076,-8080,-8083,-8087,-8090,-8093,-8097,-8100,-8103,-8106,-8109,-8112,-8115,-8118,-8121,-8124,-8126,-8129,-8132,-8134,-8137,-8139,-8142,-8144,-8146,-8148,-8150,-8153,-8155,-8157,-8159,-8160,-8162,-8164,-8166,-8167,-8169,-8171,-8172,-8173,-8175,-8176,-8177,-8179,-8180,-8181,-8182,-8183,-8184,-8185,-8185,-8186,-8187,-8188,-8188,-8189,-8189,-8190,-8190,-8190,-8191,-8191,-8191,-8191,-8191,-8191,-8191,-8191,-8191,-8190,-8190,-8190,-8189,-8189,-8188,-8188,-8187,-8186,-8186,-8185,-8184,-8183,-8182,-8181,-8180,-8179,-8177,-8176,-8175,-8173,-8172,-8171,-8169,-8167,-8166,-8164,-8162,-8160,-8159,-8157,-8155,-8153,-8151,-8148,-8146,-8144,-8142,-8139,-8137,-8134,-8132,-8129,-8126,-8124,-8121,-8118,-8115,-8112,-8109,-8106,-8103,-8100,-8097,-8093,-8090,-8087,-8083,-8080,-8076,-8073,-8069,-8065,-8062,-8058,-8054,-8050,-8046,-8042,-8038,-8034,-8029,-8025,-8021,-8016,-8012,-8008,-8003,-7998,-7994,-7989,-7984,-7979,-7975,-7970,-7965,-7960,-7955,-7949,-7944,-7939,-7934,-7928,-7923,-7917,-7912,-7906,-7901,-7895,-7889,-7883,-7878,-7872,-7866,-7860,-7854,-7848,-7841,-7835,-7829,-7823,-7816,-7810,-7803,-7797,-7790,-7783,-7777,-7770,-7763,-7756,-7749,-7742,-7735,-7728,-7721,-7714,-7707,-7699,-7692,-7685,-7677,-7670,-7662,-7655,-7647,-7639,-7631,-7624,-7616,-7608,-7600,-7592,-7584,-7576,-7568,-7559,-7551,-7543,-7534,-7526,-7517,-7509,-7500,-7492,-7483,-7474,-7465,-7456,-7448,-7439,-7430,-7421,-7411,-7402,-7393,-7384,-7375,-7365,-7356,-7346,-7337,-7327,-7318,-7308,-7298,-7288,-7279,-7269,-7259,-7249,-7239,-7229,-7219,-7209,-7198,-7188,-7178,-7167,-7157,-7147,-7136,-7126,-7115,-7104,-7094,-7083,-7072,-7061,-7050,-7039,-7028,-7017,-7006,-6995,-6984,-6973,-6961,-6950,-6939,-6927,-6916,-6904,-6893,-6881,-6870,-6858,-6846,-6834,-6822,-6811,-6799,-6787,-6775,-6763,-6750,-6738,-6726,-6714,-6701,-6689,-6677,-6664,-6652,-6639,-6627,-6614,-6601,-6589,-6576,-6563,-6550,-6537,-6524,-6511,-6498,-6485,-6472,-6459,-6446,-6433,-6419,-6406,-6393,-6379,-6366,-6352,-6339,-6325,-6311,-6298,-6284,-6270,-6256,-6242,-6229,-6215,-6201,-6187,-6172,-6158,-6144,-6130,-6116,-6101,-6087,-6073,-6058,-6044,-6029,-6015,-6000,-5986,-5971,-5956,-5942,-5927,-5912,-5897,-5882,-5867,-5852,-5837,-5822,-5807,-5792,-5777,-5762,-5746,-5731,-5716,-5700,-5685,-5669,-5654,-5638,-5623,-5607,-5592,-5576,-5560,-5544,-5529,-5513,-5497,-5481,-5465,-5449,-5433,-5417,-5401,-5385,-5368,-5352,-5336,-5320,-5303,-5287,-5271,-5254,-5238,-5221,-5205,-5188,-5171,-5155,-5138,-5121,-5105,-5088,-5071,-5054,-5037,-5020,-5003,-4986,-4969,-4952,-4935,-4918,-4901,-4884,-4866,-4849,-4832,-4815,-4797,-4780,-4762,-4745,-4727,-4710,-4692,-4675,-4657,-4639,-4622,-4604,-4586,-4569,-4551,-4533,-4515,-4497,-4479,-4461,-4443,-4425,-4407,-4389,-4371,-4353,-4335,-4316,-4298,-4280,-4262,-4243,-4225,-4206,-4188,-4170,-4151,-4133,-4114,-4096,-4077,-4058,-4040,-4021,-4002,-3984,-3965,-3946,-3927,-3908,-3890,-3871,-3852,-3833,-3814,-3795,-3776,-3757,-3738,-3719,-3700,-3680,-3661,-3642,-3623,-3604,-3584,-3565,-3546,-3526,-3507,-3488,-3468,-3449,-3429,-3410,-3390,-3371,-3351,-3332,-3312,-3292,-3273,-3253,-3233,-3214,-3194,-3174,-3154,-3135,-3115,-3095,-3075,-3055,-3035,-3015,-2995,-2975,-2955,-2935,-2915,-2895,-2875,-2855,-2835,-2815,-2795,-2775,-2754,-2734,-2714,-2694,-2674,-2653,-2633,-2613,-2592,-2572,-2552,-2531,-2511,-2490,-2470,-2449,-2429,-2409,-2388,-2367,-2347,-2326,-2306,-2285,-2265,-2244,-2223,-2203,-2182,-2161,-2141,-2120,-2099,-2079,-2058,-2037,-2016,-1995,-1975,-1954,-1933,-1912,-1891,-1870,-1850,-1829,-1808,-1787,-1766,-1745,-1724,-1703,-1682,-1661,-1640,-1619,-1598,-1577,-1556,-1535,-1514,-1493,-1472,-1451,-1429,-1408,-1387,-1366,-1345,-1324,-1303,-1281,-1260,-1239,-1218,-1197,-1175,-1154,-1133,-1112,-1090,-1069,-1048,-1027,-1005,-984,-963,-941,-920,-899,-878,-856,-835,-814,-792,-771,-750,-728,-707,-685,-664,-643,-621,-600,-579,-557,-536,-514,-493,-472,-450,-429,-407,-386,-364,-343,-322,-300,-279,-257,-236,-214,-193,-172,-150,-129,-107,-86,-64,-43,-21,-0
};
float osc1_sin_lut_index[] = {0};
float osc2_sin_lut_index[] = {0};
float osc3_sin_lut_index[] = {0};
float osc4_sin_lut_index[] = {0};

extern const float lin_to_exp_lut[1344*20];

// Initialize values
void osc_init(void)
{

}

// Creates new sample values for osc
void osc_gen1(int wave_shape, int freq, float duty_cycle, int16_t osc_out_buffer[], float lfo_buffer[], float lfo_pitch_mod_amount, float ADSR_buffer[], float ADSR_pitch_mod_amount, int offset)
{
	int samples_per_cycle = 48000/freq;
	int saw_increment = 8191*2/samples_per_cycle;
	float incr_amount = 0;
	int freq_add_to_base = 0;
	int loop_count = 0;

	for (int i = 0; i<SAMPLE_BUFFER_SIZE/2; i += 2)  //fills 1/2 of buffer
	{

		if (loop_count == 0)  //only calculates new modulation values every 10 samples to reduce computational intensity
		{
			if ((lfo_pitch_mod_amount != 0) | (ADSR_pitch_mod_amount != 0))
			{
				//calculates how much to add to base frequency based on LFO and ADSR sample values
				freq_add_to_base = lin_to_exp_lut[(int)(lfo_buffer[i] * lfo_pitch_mod_amount * 1343.0 * 20)] - 20;
				freq_add_to_base += lin_to_exp_lut[(int)(ADSR_buffer[i] * ADSR_pitch_mod_amount * 1343.0 * 20)] - 20;
				samples_per_cycle = 48000/(freq + freq_add_to_base - 20);
				saw_increment = 8191*2/samples_per_cycle;
			}
			loop_count++;
		}
		else if (loop_count == 10)
		{
			loop_count = 0;
		}
		else
		{
			loop_count++;
		}

		switch(wave_shape)
		{
			case SQU:  //creates a square wave at given frequency
				if(osc1_sample_index[0]<samples_per_cycle*duty_cycle)
				{
					osc_out_buffer[i + offset] = 8191;
				}
				else if(osc1_sample_index[0]>samples_per_cycle*duty_cycle)
				{
					osc_out_buffer[i + offset] = -8191;
				}
				osc1_sample_index[0]++;
				if(osc1_sample_index[0] >= samples_per_cycle)
				{
					osc1_sample_index[0] = 0;
				}
				break;

			case SAW:  //creates a saw wave at given frequency
				if(osc1_sample_index[0] == 0)
				{
					sample_value_osc1[0] = 8191;
				}
				else
				{
					sample_value_osc1[0] = __SSUB16(sample_value_osc1[0],saw_increment) ;

				}
				osc_out_buffer[i + offset] = sample_value_osc1[0];
				osc1_sample_index[0]++;
				if(osc1_sample_index[0] >= samples_per_cycle)
				{
					osc1_sample_index[0] = 0;
				}
				break;

			case TRI:  //creates a triangle wave at given frequency
				if(osc1_sample_index[0] == 0)
				{
					sample_value_osc1[0] = 8191;
				}
				else if (osc1_sample_index[0] <= samples_per_cycle/2)
				{
					sample_value_osc1[0] -= saw_increment*2;
				}
				else if (osc1_sample_index[0] > samples_per_cycle/2)
				{
					sample_value_osc1[0] += saw_increment*2;
				}
				osc_out_buffer[i + offset] = sample_value_osc1[0];
				osc1_sample_index[0]++;
				if(osc1_sample_index[0] >= samples_per_cycle)
				{
					osc1_sample_index[0] = 0;
				}
				break;

			case SIN:  //creates a sin wave at given frequency
				incr_amount = (float)(freq+freq_add_to_base)/20.f;
				osc_out_buffer[i + offset] = osc_sin_lut[(int)osc1_sin_lut_index[0]];
				osc1_sin_lut_index[0] += incr_amount;
				if (osc1_sin_lut_index[0] >= 2400.f)
				{
					osc1_sin_lut_index[0] -= 2400.f;
				}
				break;

			case NOI:  //creates random white noise
				osc_out_buffer[i + offset] = ((rand() % 65534) - 32767);
				osc1_sample_index[0]++;
				if(osc1_sample_index[0] >= samples_per_cycle)
				{
					osc1_sample_index[0] = 0;
				}
				break;
		}
	}
}

void osc_gen2(int wave_shape, int freq, float duty_cycle, int16_t osc_out_buffer[], float lfo_buffer[], float lfo_pitch_mod_amount, float ADSR_buffer[], float ADSR_pitch_mod_amount, int offset)
{
	int samples_per_cycle = 48000/freq;
	int saw_increment = 8191*2/samples_per_cycle;
	float incr_amount = 0;
	int freq_add_to_base = 0;
	int loop_count = 0;

	for (int i = 0; i<SAMPLE_BUFFER_SIZE/2; i += 2)
	{

		if (loop_count == 0)
		{
			if ((lfo_pitch_mod_amount != 0) | (ADSR_pitch_mod_amount != 0))
			{
				freq_add_to_base = lin_to_exp_lut[(int)(lfo_buffer[i] * lfo_pitch_mod_amount * 1343.0 * 20)] - 20;
				freq_add_to_base += lin_to_exp_lut[(int)(ADSR_buffer[i] * ADSR_pitch_mod_amount * 1343.0 * 20)] - 20;
				samples_per_cycle = 48000/(freq + freq_add_to_base - 20);
				saw_increment = 8191*2/samples_per_cycle;
			}
			loop_count++;
		}
		else if (loop_count == 10)
		{
			loop_count = 0;
		}
		else
		{
			loop_count++;
		}

		switch(wave_shape)
		{
			case SQU:
				if(osc2_sample_index[0]<samples_per_cycle*duty_cycle)
				{
					osc_out_buffer[i + offset] = 8191;
				}
				else if(osc2_sample_index[0]>samples_per_cycle*duty_cycle)
				{
					osc_out_buffer[i + offset] = -8191;
				}
				osc2_sample_index[0]++;
				if(osc2_sample_index[0] >= samples_per_cycle)
				{
					osc2_sample_index[0] = 0;
				}
				break;

			case SAW:
				if(osc2_sample_index[0] == 0)
				{
					sample_value_osc2[0] = 8191;
				}
				else
				{
					sample_value_osc2[0] = __SSUB16(sample_value_osc2[0],saw_increment) ;

				}
				osc_out_buffer[i + offset] = sample_value_osc2[0];
				osc2_sample_index[0]++;
				if(osc2_sample_index[0] >= samples_per_cycle)
				{
					osc2_sample_index[0] = 0;
				}
				break;

			case TRI:
				if(osc2_sample_index[0] == 0)
				{
					sample_value_osc2[0] = 8191;
				}
				else if (osc2_sample_index[0] <= samples_per_cycle/2)
				{
					sample_value_osc2[0] -= saw_increment*2;
				}
				else if (osc2_sample_index[0] > samples_per_cycle/2)
				{
					sample_value_osc2[0] += saw_increment*2;
				}
				osc_out_buffer[i + offset] = sample_value_osc2[0];
				osc2_sample_index[0]++;
				if(osc2_sample_index[0] >= samples_per_cycle)
				{
					osc2_sample_index[0] = 0;
				}
				break;

			case SIN:
				incr_amount = (float)(freq+freq_add_to_base)/20.f;
				osc_out_buffer[i + offset] = osc_sin_lut[(int)osc2_sin_lut_index[0]];
				osc2_sin_lut_index[0] += incr_amount;
				if (osc2_sin_lut_index[0] >= 2400.0)
				{
					osc2_sin_lut_index[0] -= 2400.0;
				}
				break;

			case NOI:
				osc_out_buffer[i + offset] = ((rand() % 65534) - 32767);
				osc2_sample_index[0]++;
				if(osc2_sample_index[0] >= samples_per_cycle)
				{
					osc2_sample_index[0] = 0;
				}
				break;
		}
	}
}

void osc_gen3(int wave_shape, int freq, float duty_cycle, int16_t osc_out_buffer[], float lfo_buffer[], float lfo_pitch_mod_amount, float ADSR_buffer[], float ADSR_pitch_mod_amount, int offset)
{
	int samples_per_cycle = 48000/freq;
	int saw_increment = 8191*2/samples_per_cycle;
	float incr_amount = 0;
	int freq_add_to_base = 0;
	int loop_count = 0;

	for (int i = 0; i<SAMPLE_BUFFER_SIZE/2; i += 2)
	{

		if (loop_count == 0)
		{
			if ((lfo_pitch_mod_amount != 0) | (ADSR_pitch_mod_amount != 0))
			{
				freq_add_to_base = lin_to_exp_lut[(int)(lfo_buffer[i] * lfo_pitch_mod_amount * 1343.0 * 20)] - 20;
				freq_add_to_base += lin_to_exp_lut[(int)(ADSR_buffer[i] * ADSR_pitch_mod_amount * 1343.0 * 20)] - 20;
				samples_per_cycle = 48000/(freq + freq_add_to_base - 20);
				saw_increment = 8191*2/samples_per_cycle;
			}
			loop_count++;
		}
		else if (loop_count == 10)
		{
			loop_count = 0;
		}
		else
		{
			loop_count++;
		}

		switch(wave_shape)
		{
			case SQU:
				if(osc3_sample_index[0]<samples_per_cycle*duty_cycle)
				{
					osc_out_buffer[i + offset] = 8191;
				}
				else if(osc3_sample_index[0]>samples_per_cycle*duty_cycle)
				{
					osc_out_buffer[i + offset] = -8191;
				}
				osc3_sample_index[0]++;
				if(osc3_sample_index[0] >= samples_per_cycle)
				{
					osc3_sample_index[0] = 0;
				}
				break;

			case SAW:
				if(osc3_sample_index[0] == 0)
				{
					sample_value_osc3[0] = 8191;
				}
				else
				{
					sample_value_osc3[0] = __SSUB16(sample_value_osc3[0],saw_increment) ;

				}
				osc_out_buffer[i + offset] = sample_value_osc3[0];
				osc3_sample_index[0]++;
				if(osc3_sample_index[0] >= samples_per_cycle)
				{
					osc3_sample_index[0] = 0;
				}
				break;

			case TRI:
				if(osc3_sample_index[0] == 0)
				{
					sample_value_osc3[0] = 8191;
				}
				else if (osc3_sample_index[0] <= samples_per_cycle/2)
				{
					sample_value_osc3[0] -= saw_increment*2;
				}
				else if (osc3_sample_index[0] > samples_per_cycle/2)
				{
					sample_value_osc3[0] += saw_increment*2;
				}
				osc_out_buffer[i + offset] = sample_value_osc3[0];
				osc3_sample_index[0]++;
				if(osc3_sample_index[0] >= samples_per_cycle)
				{
					osc3_sample_index[0] = 0;
				}
				break;

			case SIN:
				incr_amount = (float)(freq+freq_add_to_base)/20.f;
				osc_out_buffer[i + offset] = osc_sin_lut[(int)osc3_sin_lut_index[0]];
				osc3_sin_lut_index[0] += incr_amount;
				if (osc3_sin_lut_index[0] >= 2400.0)
				{
					osc3_sin_lut_index[0] -= 2400.0;
				}
				break;

			case NOI:
				osc_out_buffer[i + offset] = ((rand() % 65534) - 32767);
				osc3_sample_index[0]++;
				if(osc3_sample_index[0] >= samples_per_cycle)
				{
					osc3_sample_index[0] = 0;
				}
				break;
		}
	}
}

void osc_gen4(int wave_shape, int freq, float duty_cycle, int16_t osc_out_buffer[], float lfo_buffer[], float lfo_pitch_mod_amount, float ADSR_buffer[], float ADSR_pitch_mod_amount, int offset)
{
	int samples_per_cycle = 48000/freq;
	int saw_increment = 8191*2/samples_per_cycle;
	float incr_amount = 0;
	int freq_add_to_base = 0;
	int loop_count = 0;

	for (int i = 0; i<SAMPLE_BUFFER_SIZE/2; i += 2)
	{

		if (loop_count == 0)
		{
			if ((lfo_pitch_mod_amount != 0) | (ADSR_pitch_mod_amount != 0))
			{
				freq_add_to_base = lin_to_exp_lut[(int)(lfo_buffer[i] * lfo_pitch_mod_amount * 1343.0 * 20)] - 20;
				freq_add_to_base += lin_to_exp_lut[(int)(ADSR_buffer[i] * ADSR_pitch_mod_amount * 1343.0 * 20)] - 20;
				samples_per_cycle = 48000/(freq + freq_add_to_base - 20);
				saw_increment = 8191*2/samples_per_cycle;
			}
			loop_count++;
		}
		else if (loop_count == 10)
		{
			loop_count = 0;
		}
		else
		{
			loop_count++;
		}

		switch(wave_shape)
		{
			case SQU:
				if(osc4_sample_index[0]<samples_per_cycle*duty_cycle)
				{
					osc_out_buffer[i + offset] = 8191;
				}
				else if(osc4_sample_index[0]>samples_per_cycle*duty_cycle)
				{
					osc_out_buffer[i + offset] = -8191;
				}
				osc4_sample_index[0]++;
				if(osc4_sample_index[0] >= samples_per_cycle)
				{
					osc4_sample_index[0] = 0;
				}
				break;

			case SAW:
				if(osc4_sample_index[0] == 0)
				{
					sample_value_osc4[0] = 8191;
				}
				else
				{
					sample_value_osc4[0] = __SSUB16(sample_value_osc4[0],saw_increment) ;

				}
				osc_out_buffer[i + offset] = sample_value_osc4[0];
				osc4_sample_index[0]++;
				if(osc4_sample_index[0] >= samples_per_cycle)
				{
					osc4_sample_index[0] = 0;
				}
				break;

			case TRI:
				if(osc4_sample_index[0] == 0)
				{
					sample_value_osc4[0] = 8191;
				}
				else if (osc4_sample_index[0] <= samples_per_cycle/2)
				{
					sample_value_osc4[0] -= saw_increment*2;
				}
				else if (osc4_sample_index[0] > samples_per_cycle/2)
				{
					sample_value_osc4[0] += saw_increment*2;
				}
				osc_out_buffer[i + offset] = sample_value_osc4[0];
				osc4_sample_index[0]++;
				if(osc4_sample_index[0] >= samples_per_cycle)
				{
					osc4_sample_index[0] = 0;
				}
				break;

			case SIN:
				incr_amount = (float)(freq+freq_add_to_base)/20.f;
				osc_out_buffer[i + offset] = osc_sin_lut[(int)osc4_sin_lut_index[0]];
				osc4_sin_lut_index[0] += incr_amount;
				if (osc4_sin_lut_index[0] >= 2400.0)
				{
					osc4_sin_lut_index[0] -= 2400.0;
				}
				break;

			case NOI:
				osc_out_buffer[i + offset] = ((rand() % 65534) - 32767);
				osc4_sample_index[0]++;
				if(osc4_sample_index[0] >= samples_per_cycle)
				{
					osc4_sample_index[0] = 0;
				}
				break;
		}
	}
}
